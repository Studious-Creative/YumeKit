name: Publish & Deploy

on:
    push:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: 20

            - run: npm ci

            - name: Install Playwright browsers
              run: npx playwright install --with-deps chromium

            - run: npm test

    build-and-publish:
        needs: test
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.pkg.outputs.version }}
        permissions:
            contents: read
            id-token: write
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  registry-url: https://registry.npmjs.org/

            - name: Read package version
              id: pkg
              run: echo "version=$(jq -r .version package.json)" >> "$GITHUB_OUTPUT"

            - run: npm ci
            - run: npm run build

            - name: Publish to NPM
              run: npm publish --provenance --access public
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Upload dist artifact
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist/

    deploy-cdn:
        needs: build-and-publish
        runs-on: ubuntu-latest
        permissions:
            id-token: write
            contents: read
        steps:
            - name: Download dist artifact
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: dist/

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
                  aws-region: ${{ secrets.AWS_REGION }}

            # Upload versioned copy
            - name: Deploy versioned to S3
              run: |
                  aws s3 sync dist/ s3://${{ secrets.AWS_S3_BUCKET }}/${{ needs.build-and-publish.outputs.version }}/ \
                    --delete --cache-control "public, max-age=31536000, immutable"

            # Upload "latest" copy
            - name: Deploy latest to S3
              run: |
                  aws s3 sync dist/ s3://${{ secrets.AWS_S3_BUCKET }}/latest/ \
                    --delete --cache-control "public, max-age=300"

            # Optional: invalidate CloudFront cache for /latest/
            # - name: Invalidate CloudFront
            #   run: |
            #     aws cloudfront create-invalidation \
            #       --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            #       --paths "/latest/*"
